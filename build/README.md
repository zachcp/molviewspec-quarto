# Build Directory

This directory contains the source files and build configuration for the MolViewSpec Quarto extension.

## Build Flow

```
build/molviewspec.ts
       ↓
  [deno task build]
       ↓
   build.ts (esbuild)
       ↓
   Compiles & Bundles:
   • molviewspec.ts → _extensions/molviewspec-quarto/molviewspec.js (ESM, 8.6MB)
   • Monaco workers → _extensions/molviewspec-quarto/assets/*.worker.js (IIFE)
       - editor.worker.js (596KB)
       - ts.worker.js (13MB)
   • Monaco CSS → _extensions/molviewspec-quarto/molviewspec.css (auto-generated)
```

## Files

### Source Files
- **`molviewspec.ts`** - Main entry point, initializes viewers using `@molstar/molstar-components`
- **`build.ts`** - esbuild configuration, handles bundling and worker generation

### Build Command
```bash
deno task build
```

## Dependencies

### Runtime (bundled in molviewspec.js)
- `preact@10.28.1` - React alternative
- `@molstar/molstar-components` - Preact components for MolStar + Monaco
- `monaco-editor@0.55.1` - Code editor (must match component version)

### Build Tools (deno.json)
- `esbuild@^0.24.2` - Bundler
- `@luca/esbuild-deno-loader@^0.11.1` - Deno import resolution for esbuild

## Key Details

### Monaco Editor Workers
- Workers **must** be built separately from main bundle (IIFE format)
- Worker version **must** match main bundle Monaco version (0.55.1)
- Workers are loaded via `window.MonacoEnvironment.getWorkerUrl()` configured in Lua filter

### Bundle Format
- Main bundle: ES module (`format: "esm"`)
- Workers: Immediately Invoked Function Expression (`format: "iife"`)

### Output Location
All output goes to `_extensions/molviewspec-quarto/`:
- `molviewspec.js` - Main bundle (loads on page)
- `molviewspec.css` - Monaco CSS (auto-generated, don't edit)
- `molviewspec-custom.css` - Custom styles (safe to edit)
- `assets/` - Workers, MolStar library, fonts

## Build Configuration

**Platform:** `browser`  
**Target:** `es2022`  
**JSX:** `automatic` with `jsxImportSource: "preact"`  
**Minification:** Disabled for debugging  

## Important Notes

1. **Don't edit `molviewspec.css`** - it's auto-generated by esbuild from Monaco's CSS
2. **Use `molviewspec-custom.css`** for custom styling
3. **Monaco version must match** between workers and main bundle
4. **Workers must load before Monaco initializes** - handled by Lua filter's `<head>` script
